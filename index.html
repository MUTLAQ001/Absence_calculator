<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="مستشارك الدراسي الشخصي لتتبع الغياب. إصدار مستقر وفائق التوافقية.">
	<meta name="theme-color" content="#0a0a0a">
	<title>حاسبة الغياب - الإصدار النهائي</title>

	<!-- PWA & Mobile App Settings -->
	<link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22%D8%AD%D8%A7%D8%B3%D8%A8%D8%A9%20%D8%A7%D9%84%D8%BA%D9%8A%D8%A7%D8%A8%22%2C%22short_name%22%3A%22%D8%AD%D8%A7%D8%B3%D8%A8%D8%A9%20%D8%A7%D9%84%D8%BA%D9%8A%D8%A7%D8%A8%22%2C%22description%22%3A%22%D9%85%D8%B3%D8%AA%D8%B4%D8%A7%D8%B1%D9%83%20%D8%A7%D9%84%D8%AF%D8%B1%D8%A7%D8%B3%D9%8A%20%D8%A7%D9%84%D8%B4%D8%AE%D8%B5%D9%8A%20%D9%84%D8%AA%D8%AA%D8%A8%D8%B9%20%D8%A7%D9%84%D8%BA%D9%8A%D8%A7%D8%A8.%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230a0a0a%22%2C%22theme_color%22%3A%22%230a0a0a%22%2C%22orientation%22%3A%22portrait-primary%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage/svg%2Bxml%3Bbase64%2CPHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI%2BPHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIHJ4PSI5MCIgZmlsbD0iIzBhMGEwYSIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDY0IDApIj48cmVjdCB4PSI2NCIgeT0iNDgiIHdpZHRoPSIzODQiIGhlaWdodD0iNDE2IiByeD0iNDAiIGZpbGw9IiMyMjI1MmQiLz48cmVjdCB4PSI5NiIgeT0iODAiIHdpZHRoPSIzMjAiIGhlaWdodD0iOTYiIHJ4PSIyMCIgZmlsbD0iIzVlOWNmZiIvPjxnIGZpbGw9IiM0YjUwNWEiPjxjaXJjbGUgY3g9IjE1MCIgY3k9IjI0MCIgcj0iMzIiLz48Y2lyY2xlIGN4PSIyNTYiIGN5PSIyNDAiIHI9IjMyIi8%2BY2lyY2xlIGN4PSIzNjIiIGN5PSIyNDAiIHI9IjMyIi8%2BY2lyY2xlIGN4PSIxNTAiIGN5PSIzMzAiIHI9IjMyIi8%2BY2lyY2xlIGN4PSIyNTYiIGN5PSIzMzAiIHI9IjMyIi8%2BY2lyY2xlIGN4PSIzNjIiIGN5PSIzMzAiIHI9IjMyIi8%2BY2lyY2xlIGN4PSIxNTAiIGN5PSI0MjAiIHI9IjMyIi8%2BY2lyY2xlIGN4PSIyNTYiIGN5PSI0MjAiIHI9IjMyIi8%2BY2lyY2xlIGN4PSIzNjIiIGN5PSI0MjAiIHI9IjMyIi8%2BPC9nPjwvZz48L3N2Zz4%3D%22%2C%22sizes%22%3A%22192x192%20512x512%22%2C%22type%22%3A%22image/svg%2Bxml%22%7D%5D%7D">
	<link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIHJ4PSI5MCIgZmlsbD0iIzBhMGEwYSIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDY0IDApIj48cmVjdCB4PSI2NCIgeT0iNDgiIHdpZHRoPSIzODQiIGhlaWdodD0iNDE2IiByeD0iNDAiIGZpbGw9IiMyMjI1MmQiLz48cmVjdCB4PSI5NiIgeT0iODAiIHdpZHRoPSIzMjAiIGhlaWdodD0iOTYiIHJ4PSIyMCIgZmlsbD0iIzVlOWNmZiIvPjxnIGZpbGw9IiM0YjUwNWEiPjxjaXJjbGUgY3g9IjE1MCIgY3k9IjI0MCIgcj0iMzIiLz48Y2lyY2xlIGN4PSIyNTYiIGN5PSIyNDAiIHI9IjMyIi8+PGNpcmNsZSBjeD0iMzYyIiBjeT0iMjQwIiByPSIzMiIvPjxjaXJjbGUgY3g9IjE1MCIgY3k9IjMzMCIgcj0iMzIiLz48Y2lyY2xlIGN4PSIyNTYiIGN5PSIzMzAiIHI9IjMyIi8+PGNpcmNsZSBjeD0iMzYyIiBjeT0iMzMwIiByPSIzMiIvPjxjaXJjbGUgY3g9IjE1MCIgY3k9IjQyMCIgcj0iMzIiLz48Y2lyY2xlIGN4PSIyNTYiIGN5PSI0MjAiIHI9IjMyIi8+PGNpcmNsZSBjeD0iMzYyIiBjeT0iNDIwIiByPSIzMiIvPjwvZz48L2c+PC9zdmc+">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="حاسبة الغياب">

	<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
	<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="https://unpkg.com/framer-motion@7.6.5/dist/framer-motion.js"></script>
	<style>
		@import url("https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap");
		:root{--color-primary:#5e9cff;--color-primary-dark:#3a71c5;--color-sky:#87ceeb;--color-danger:#ff5252;--color-warning:#ffc400;--color-safe:#00e676;--color-bg:#0a0a0a;--color-card:rgba(20,20,22,0.75);--color-border:rgba(255,255,255,0.1);--color-text:#e0e0e0;--color-text-muted:#999;--font-body:"Cairo",sans-serif;--radius:16px;--transition:0.3s cubic-bezier(0.25,0.8,0.25,1);--rgb-primary:94,156,255}
		*{margin:0;padding:0;box-sizing:border-box;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
		body{font-family:var(--font-body);background-color:var(--color-bg);color:var(--color-text);direction:rtl;overflow-x:hidden}
		.app{min-height:100vh;position:relative;padding:2rem 1rem}
		.aurora-bg{position:fixed;top:0;left:0;width:100%;height:100%;overflow:hidden;z-index:-1;transition:all .5s ease}
		.aurora-dot{position:absolute;border-radius:50%;filter:blur(120px);opacity:.25;transition:background-color .5s ease}
		.aurora-dot-1{width:50vw;height:50vw;background-color:var(--color-primary);top:5%;left:0%;animation:move-aurora-1 25s infinite alternate ease-in-out}
		.aurora-dot-2{width:45vw;height:45vw;background-color:var(--color-primary-dark);bottom:10%;right:5%;animation:move-aurora-2 30s infinite alternate-reverse ease-in-out}
		@keyframes move-aurora-1{from{transform:translate(0,0)}to{transform:translate(15vw,20vh)}}
		@keyframes move-aurora-2{from{transform:translate(0,0)}to{transform:translate(-10vw,-15vh)}}
		.container{width:100%;max-width:650px;z-index:1;display:flex;flex-direction:column;gap:1.5rem;margin:0 auto;position:relative}
		.main-header{text-align:center}
		.main-header h1{font-family:var(--font-body);font-weight:700;font-size:2.8rem;margin-bottom:.5rem;background:linear-gradient(90deg,var(--color-primary),var(--color-sky));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
		.main-header p{color:var(--color-text-muted);font-size:1rem}
		.card{background:var(--color-card);border:1px solid var(--color-border);border-radius:var(--radius);padding:1.5rem;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);transition:var(--transition);position:relative;box-shadow:0 10px 30px rgba(0,0,0,0.2)}
		.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1.5rem;border-bottom:1px solid var(--color-border)}
		.card-header h2{font-family:var(--font-body);font-weight:700;font-size:1.7rem;color:#fff;display:flex;align-items:center;gap:.75rem}
		.input-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1.25rem}
		.input-group{display:flex;flex-direction:column;gap:.5rem}
		.input-group label{font-size:.9rem;color:var(--color-text-muted)}
		.input-group input,.input-group select{width:100%;background:rgba(0,0,0,0.3);border:1px solid var(--color-border);border-radius:8px;padding:.75rem;color:var(--color-text);font-size:1rem;transition:var(--transition)}
		.input-group input[type="date"]{color-scheme:dark}
		.input-group input:focus,.input-group select:focus{outline:none;border-color:var(--color-primary);box-shadow:0 0 0 3px rgba(var(--rgb-primary),0.4)}
		.absence-control{display:flex;align-items:center;background:rgba(0,0,0,0.3);border:1px solid var(--color-border);border-radius:8px;overflow:hidden}
		.absence-control input{flex-grow:1;border:none!important;background:transparent!important;text-align:center;box-shadow:none!important;padding:.75rem .25rem}
		.absence-control button{background:rgba(255,255,255,0.05);border:none;color:var(--color-text);font-size:1.5rem;cursor:pointer;padding:0 1rem;transition:all .2s ease;height:100%;user-select:none}
		.absence-control button:hover{background:rgba(var(--rgb-primary),0.2);color:var(--color-primary)}
		.absence-control input::-webkit-inner-spin-button{margin:0}
		.divider{height:1px;background:var(--color-border);margin:1.5rem 0}
		.day-selector{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center}
		.day-selector button{font-family:var(--font-body);font-size:.8rem;font-weight:bold;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--color-text-muted);background:rgba(0,0,0,0.2);border:1px solid var(--color-border);transition:all .2s ease}
		.day-selector button.active{color:var(--color-bg);background:var(--color-primary);border-color:var(--color-primary)}
		.action-button{width:100%;padding:.8rem;font-size:1.1rem;font-weight:600;border:none;border-radius:8px;cursor:pointer;background:linear-gradient(90deg,var(--color-primary-dark),var(--color-primary));color:#fff;transition:all .2s ease-in-out;display:flex;justify-content:center;align-items:center;gap:.5rem;user-select:none}
		.action-button:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 4px 15px rgba(var(--rgb-primary),0.25)}
		.action-button:disabled{opacity:0.5;cursor:not-allowed}
		.action-button.saved{background:var(--color-safe)}
		.course-list{display:flex;flex-direction:column;gap:1rem}
		.course-item{display:grid;grid-template-columns:1fr auto;padding:1rem;background:rgba(0,0,0,0.2);border-radius:12px;border-right:4px solid;row-gap:.75rem;column-gap:1rem}
		.course-item.status-safe{border-right-color:var(--color-safe)}
		.course-item.status-warning{border-right-color:var(--color-warning)}
		.course-item.status-danger{border-right-color:var(--color-danger)}
		.course-item .progress-bar{grid-column:1/-1;grid-row:5/6;width:100%;height:6px;background:var(--color-border);border-radius:3px;overflow:hidden}
		.course-item .progress-bar-inner{height:100%;border-radius:3px;transition:all .5s ease}
		.course-item.status-safe .progress-bar-inner{background:var(--color-safe)}
		.course-item.status-warning .progress-bar-inner{background:var(--color-warning)}
		.course-item.status-danger .progress-bar-inner{background:var(--color-danger)}
		.course-info{grid-column:1/2}
		.course-info h3{font-size:1.3rem;font-weight:600;color:#fff}
		.course-info p{color:var(--color-text-muted);font-size:0.9rem}
		.course-actions{grid-column:2/3;grid-row:1/2;display:flex;align-items:flex-start;gap:.5rem}
		.course-actions button{background:none;border:none;color:var(--color-text-muted);font-size:1.2rem;cursor:pointer;transition:var(--transition);padding:0.25rem}
		.course-actions button:hover{color:#fff}
		.course-meta{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;font-size:0.9rem}
		.meta-item{display:flex;align-items:center;gap:0.5rem;font-weight:600}
		.meta-item.status-safe{color:var(--color-safe)}
		.meta-item.status-warning{color:var(--color-warning)}
		.meta-item.status-danger{color:var(--color-danger)}
		.quick-controls{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;padding-top:0.75rem;border-top:1px solid var(--color-border);margin-top:0.75rem;}
        .last-updated{font-size:0.8rem; color: var(--color-text-muted);}
		.footer{text-align:center;color:var(--color-text-muted);font-size:.9rem;display:flex;justify-content:space-between;align-items:center;padding-top:1rem;border-top:1px solid var(--color-border);}
		.footer-controls{display:flex;align-items:center;gap:1rem}
		.theme-picker{display:flex;gap:.5rem}
		.theme-dot{width:20px;height:20px;border-radius:50%;cursor:pointer;transition:transform .2s ease;border:2px solid transparent;background:none;padding:0}
		.theme-dot:hover{transform:scale(1.2)}
		.theme-dot.active{border-color:#fff}
		.theme-dot-inner{width:100%;height:100%;border-radius:50%}
		.footer-link{color:var(--color-text-muted);transition:var(--transition);display:inline-flex;align-items:center;gap:0.3rem;text-decoration:none}
		.footer-link:hover{color:#fff}
		.footer-link svg{font-size:1.4rem}
		.clear-button{background:none;border:none;color:var(--color-text-muted);font-size:1.5rem;cursor:pointer;transition:var(--transition)}
		.clear-button:hover{color:var(--color-danger)}
		.empty-list-message{text-align:center;padding:2rem;color:var(--color-text-muted);border:2px dashed var(--color-border);border-radius:var(--radius);display:flex;flex-direction:column;align-items:center;gap:1rem}
		.empty-list-message svg{font-size:3rem;color:var(--color-primary)}
		.swal2-popup{background:var(--color-card)!important;color:var(--color-text)!important;border-radius:var(--radius)!important;border:1px solid var(--color-border)!important}
		.swal2-title{color:var(--color-text)!important}
		.swal2-confirm{background:var(--color-primary)!important;border-radius:8px!important}
		.swal2-cancel{border-radius:8px!important}
		@media(max-width:600px){.app{padding:1rem}.main-header h1{font-size:2.2rem}.card{padding:1.25rem}.card-header h2{font-size:1.5rem}.footer{flex-direction:column;gap:1rem}}
	</style>
</head>
<body>
	<div id="root"></div>
	<script type="text/javascript">
		const { useState, useEffect, useMemo, useCallback, StrictMode, memo } = React;
		const { motion, AnimatePresence } = framerMotion;
		const e = React.createElement;

		const SvgIcon = (props) => e("svg", { xmlns: "http://www.w3.org/2000/svg", width: "24", height: "24", viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", ...props });
		const Icons = {
			Minus: (props) => e(SvgIcon, props, e("line", { x1: "5", y1: "12", x2: "19", y2: "12" })),
			Plus: (props) => e(SvgIcon, props, e("line", { x1: "12", y1: "5", x2: "12", y2: "19" }), e("line", { x1: "5", y1: "12", x2: "19", y2: "12" })),
			Edit: (props) => e(SvgIcon, props, e("path", { d: "M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" }), e("path", { d: "M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" })),
			Trash: (props) => e(SvgIcon, props, e("polyline", { points: "3 6 5 6 21 6" }), e("path", { d: "M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" })),
			Save: (props) => e(SvgIcon, props, e("path", { d: "M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" }), e("polyline", { points: "17 21 17 13 7 13 7 21" }), e("polyline", { points: "7 3 7 8 15 8" })),
			Telegram: (props) => e(SvgIcon, props, e("path", { d: "M22 2L11 13M22 2L15 22L11 13L2 9L22 2z" })),
			Check: (props) => e(SvgIcon, props, e("polyline", { points: "20 6 9 17 4 12" })),
			Calendar: (props) => e(SvgIcon, props, e("rect", { x: "3", y: "4", width: "18", height: "18", rx: "2", ry: "2" }), e("line", { x1: "16", y1: "2", x2: "16", y2: "6" }), e("line", { x1: "8", y1: "2", x2: "8", y2: "6" }), e("line", { x1: "3", y1: "10", x2: "21", y2: "10" })),
			List: (props) => e(SvgIcon, props, e("line", { x1: "8", y1: "6", x2: "21", y2: "6" }), e("line", { x1: "8", y1: "12", x2: "21", y2: "12" }), e("line", { x1: "8", y1: "18", x2: "21", y2: "18" }), e("line", { x1: "3", y1: "6", x2: "3.01", y2: "6" }), e("line", { x1: "3", y1: "12", x2: "3.01", y2: "12" }), e("line", { x1: "3", y1: "18", x2: "3.01", y2: "18" })),
			Settings: (props) => e(SvgIcon, props, e("circle", { cx: "12", cy: "12", r: "3" }), e("path", { d: "M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V12a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" })),
		};
		const CONSTANTS = { DENIAL_PERCENTAGE: 0.25 };
		const THEMES = {
			blue: { name:'أزرق', '--color-primary': '#5e9cff', '--color-primary-dark': '#3a71c5', '--color-sky': '#87ceeb', '--rgb-primary': '94,156,255' },
			purple: { name:'بنفسجي', '--color-primary': '#a777ff', '--color-primary-dark': '#8a52e0', '--color-sky': '#d9b8ff', '--rgb-primary': '167,119,255' },
			green: { name:'أخضر', '--color-primary': '#00e676', '--color-primary-dark': '#00b05b', '--color-sky': '#7cffb6', '--rgb-primary': '0,230,118' },
		};
		const DAYS_OF_WEEK = ['ح', 'ن', 'ث', 'ر', 'خ', 'ج', 'س'];

		const useLocalStorage = (key, defaultValue) => {
			const [value, setValue] = useState(() => {
				try {
					const saved = localStorage.getItem(key);
					return saved ? JSON.parse(saved) : defaultValue;
				} catch { return defaultValue; }
			});
			useEffect(() => { localStorage.setItem(key, JSON.stringify(value)); }, [key, value]);
			return [value, setValue];
		};

		const getWeeksBetween = (d1, d2) => {
			if (!d1 || !d2) return 0;
			const date1 = new Date(d1);
			const date2 = new Date(d2);
			if (date2 < date1) return 0;
			return Math.ceil((date2 - date1) / (7 * 24 * 60 * 60 * 1000));
		};

        const formatRelativeTime = (timestamp) => {
			const now = new Date(), past = new Date(timestamp), diff = (now - past) / 1000;
			if (diff < 60) return `قبل لحظات`; const mins = Math.round(diff / 60);
			if (mins < 60) return `قبل ${mins} ${mins === 1 ? 'دقيقة' : 'دقائق'}`; const hours = Math.round(diff / 3600);
			if (hours < 24) return `قبل ${hours} ${hours === 1 ? 'ساعة' : 'ساعات'}`; const days = Math.round(diff / 86400);
			return days === 1 ? "بالأمس" : `قبل ${days} أيام`;
		};

		const calculateDenialInfo = (course, settings) => {
			const { semesterStartDate, semesterEndDate, semesterWeeks } = settings;
			const lecturesPerWeek = course.schedule.length;
			if (semesterWeeks <= 0 || lecturesPerWeek === 0) return { status: 'danger', remainingText: "أكمل الإعدادات", denialDateText: "غير معروف", progress: 0 };
			const totalHours = semesterWeeks * course.lectureHours;
			const allowedAbsence = Math.floor(totalHours * CONSTANTS.DENIAL_PERCENTAGE);
			const denialStartsAt = allowedAbsence + 1;
			const remainingAbsences = allowedAbsence - course.absenceHours;
			const isDenied = course.absenceHours >= denialStartsAt;
			const progress = Math.min(100, (course.absenceHours / denialStartsAt) * 100);
			let status = isDenied ? 'danger' : (progress >= 75 ? 'warning' : 'safe');
			let remainingText = isDenied ? `متجاوز بـ ${-remainingAbsences} ساعة` : `متبقي ${remainingAbsences} ساعة`;
			let denialDateText = "آمن جدًا";
			if (!isDenied) {
				const hoursPerLecture = course.lectureHours / lecturesPerWeek;
				let lecturesToMiss = Math.ceil((remainingAbsences + 1) / hoursPerLecture);
				let currentDate = new Date() > new Date(semesterStartDate) ? new Date() : new Date(semesterStartDate);
				currentDate.setHours(0,0,0,0);
				const endDate = new Date(semesterEndDate);
				endDate.setHours(0,0,0,0);
				let safety = 365;
				while (lecturesToMiss > 0 && safety > 0) {
					currentDate.setDate(currentDate.getDate() + 1);
					if (currentDate > endDate) { lecturesToMiss = 0; break; }
					if (course.schedule.includes(currentDate.getDay())) lecturesToMiss--;
					safety--;
				}
				if (currentDate > endDate) denialDateText = "آمن لنهاية الفصل";
				else denialDateText = `الحرمان في: ${currentDate.toLocaleDateString('ar-EG', { weekday: 'short', month: 'short', day: 'numeric' })}`;
			} else { denialDateText = "تم الحرمان"; }
			return { status, remainingText, denialDateText, progress };
		};
		
        const useAppData = () => {
            const [courses, setCourses] = useLocalStorage('courses', []);
            const [settings, setSettings] = useLocalStorage('settings', { theme: 'blue', startDate: '', endDate: '' });
            const [selectedCourse, setSelectedCourse] = useState(null);
            const semesterWeeks = useMemo(() => getWeeksBetween(settings.startDate, settings.endDate), [settings.startDate, settings.endDate]);
            const isSettingsValid = semesterWeeks > 0;
            const updateSettings = (key, value) => setSettings(prev => ({...prev, [key]: value}));
            const handleSaveCourse = (courseData) => {
                setCourses(prev => {
                    const index = prev.findIndex(c => c.id === courseData.id);
                    const newCourses = [...prev];
                    const courseWithTimestamp = {...courseData, lastUpdated: Date.now()};
                    if (index > -1) newCourses[index] = courseWithTimestamp; else newCourses.push(courseWithTimestamp);
                    return newCourses.sort((a,b) => a.name.localeCompare(b.name, 'ar'));
                });
                setSelectedCourse(null);
            };
            const handleDeleteCourse = (courseId, courseName) => {
                Swal.fire({ title: `هل أنت متأكد من حذف "${courseName}"؟`, text: "لا يمكن التراجع عن هذا الإجراء!", icon: 'warning', showCancelButton: true, confirmButtonText: 'نعم, احذفها', cancelButtonText: 'إلغاء' })
                .then((result) => { if (result.isConfirmed) { setCourses(prev => prev.filter(c => c.id !== courseId)); Swal.fire('تم الحذف!', '', 'success'); } });
            };
            const handleQuickAbsence = (courseId, amount) => { setCourses(prev => prev.map(c => c.id === courseId ? { ...c, absenceHours: Math.max(0, c.absenceHours + amount), lastUpdated: Date.now() } : c )); };
            const handleResetAll = () => {
                 Swal.fire({ title: 'مسح كل البيانات؟', text: "سيتم حذف جميع المواد والإعدادات بشكل نهائي.", icon: 'error', showCancelButton: true, confirmButtonText: 'نعم, امسح كل شيء', cancelButtonText: 'إلغاء', confirmButtonColor: '#ff5252' })
                 .then((result) => { if (result.isConfirmed) { setCourses([]); setSettings({ theme: settings.theme, startDate: '', endDate: '' }); setSelectedCourse(null); } });
            };
            return { courses, settings, updateSettings, selectedCourse, setSelectedCourse, semesterWeeks, isSettingsValid, handleSaveCourse, handleDeleteCourse, handleQuickAbsence, handleResetAll };
        };

		const DaySelector = memo(({ selectedDays, onToggleDay }) => {
			return e("div", { className: "day-selector" },
				DAYS_OF_WEEK.map((day, index) => e("button", { type: "button", key: index, className: selectedDays.includes(index) ? 'active' : '', onClick: () => onToggleDay(index) }, day))
			);
		});

        const SettingsCard = memo(({ settings, onUpdate, weeks }) => {
            return e(motion.div, { layout: true, className: "card" },
                e("div", { className: "card-header" }, e("h2", { title: `الفصل الدراسي (${weeks} أسبوع)` }, e(Icons.Settings), "إعدادات الفصل الدراسي")),
                e("div", { className: "input-grid" },
                    e("div", { className: "input-group" }, e("label", { htmlFor: "semester-start" }, "تاريخ البداية"), e("input", { type: "date", id: "semester-start", value: settings.startDate, onChange: ev => onUpdate('startDate', ev.target.value) })),
                    e("div", { className: "input-group" }, e("label", { htmlFor: "semester-end" }, "تاريخ النهاية"), e("input", { type: "date", id: "semester-end", value: settings.endDate, onChange: ev => onUpdate('endDate', ev.target.value) }))
                ),
                weeks > 0 && e("p", { style: { color: 'var(--color-safe)', textAlign: 'center', marginTop: '1rem' } }, "عدد أسابيع الدراسة المحسوب: ", e("b", null, `${weeks} أسبوع.`))
            );
        });

		const CourseForm = memo(({ onSave, selectedCourse, setSelectedCourse, isSettingsValid }) => {
			const [name, setName] = useState("");
			const [lectureHours, setLectureHours] = useState(2);
			const [absenceHours, setAbsenceHours] = useState("");
			const [schedule, setSchedule] = useState([]);
			const [isSaving, setIsSaving] = useState(false);
            const isEditing = !!selectedCourse;
			const clearForm = useCallback(() => { setName(""); setLectureHours(2); setAbsenceHours(""); setSchedule([]); }, []);
			useEffect(() => {
				if (selectedCourse) { setName(selectedCourse.name); setLectureHours(selectedCourse.lectureHours); setAbsenceHours(selectedCourse.absenceHours); setSchedule(selectedCourse.schedule || []); }
                else { clearForm(); }
			}, [selectedCourse, clearForm]);
			const handleAbsenceChange = (change) => setAbsenceHours(String(Math.max(0, (parseInt(absenceHours, 10) || 0) + change)));
			const handleToggleDay = useCallback((dayIndex) => { setSchedule(prev => prev.includes(dayIndex) ? prev.filter(d => d !== dayIndex) : [...prev, dayIndex].sort()); }, []);
			const handleSubmit = (ev) => {
				ev.preventDefault();
				if (!name.trim() || isSaving) return;
				if (schedule.length === 0) { Swal.fire({ icon: 'warning', title: 'بيانات ناقصة', text: 'الرجاء تحديد يوم واحد على الأقل للمادة.'}); return; }
				setIsSaving(true);
				onSave({ id: isEditing ? selectedCourse.id : Date.now(), name: name.trim(), lectureHours: Number(lectureHours), absenceHours: parseInt(absenceHours, 10) || 0, schedule });
				setTimeout(() => setIsSaving(false), 1200);
			};
			return e(motion.div, { layout: true, className: "card" },
                e("form", { onSubmit: handleSubmit },
                    e("div", { className: "card-header" },
                        e("h2", null, e(Icons.Edit), ` ${isEditing ? "تعديل مادة" : "إضافة مادة جديدة"}`),
                        isEditing && e("button", { type: "button", className: "clear-button", onClick: () => setSelectedCourse(null), title: "إلغاء التعديل" }, "✖")
                    ),
                    e("div", { className: "input-grid" },
                        e("div", { className: "input-group", style: { gridColumn: "1 / -1" } }, e("label", { htmlFor: "course-name" }, "اسم المادة"), e("input", { type: "text", id: "course-name", value: name, onChange: ev => setName(ev.target.value), required: true })),
                        e("div", { className: "input-group" }, e("label", null, "الساعات الأسبوعية"), e("select", { value: lectureHours, onChange: ev => setLectureHours(ev.target.value) }, [...Array(8).keys()].map(i => e("option", { key: i + 1, value: i + 1 }, i + 1)))),
                        e("div", { className: "input-group" }, e("label", null, "ساعات الغياب"), e("div", { className: "absence-control" },
                            e("button", { type: "button", onClick: () => handleAbsenceChange(1) }, e(Icons.Plus)),
                            e("input", { type: "number", value: absenceHours, onChange: ev => setAbsenceHours(ev.target.value.replace(/\D/g, '')), min: "0" }),
                            e("button", { type: "button", onClick: () => handleAbsenceChange(-1) }, e(Icons.Minus))
                        ))
                    ),
                    e("div", { className: "divider" }),
                    e("label", { style: { textAlign: 'center', marginBottom: '0.75rem', display: 'block' } }, "أيام المحاضرات"),
                    e(DaySelector, { selectedDays: schedule, onToggleDay: handleToggleDay }),
                    e("button", { type: "submit", className: `action-button ${isSaving ? 'saved' : ''}`, style: { marginTop: '1.5rem' }, disabled: !name || isSaving || !isSettingsValid },
                        !isSettingsValid ? "أكمل الإعدادات أولاً" : isSaving ? e(React.Fragment, null, e(Icons.Check), " تم الحفظ") : isEditing ? e(React.Fragment, null, e(Icons.Save), " تحديث المادة") : e(React.Fragment, null, e(Icons.Plus), " إضافة المادة")
                    )
                )
            );
		});

		const CourseItem = memo(({ course, onEdit, onDelete, onQuickAbsence, settings }) => {
			const info = useMemo(() => calculateDenialInfo(course, settings), [course, settings]);
			const itemVariants = { initial: { opacity: 0, y: 20 }, animate: { opacity: 1, y: 0 }, exit: { opacity: 0, x: -50 } };
			return e(motion.div, { layout: true, variants: itemVariants, className: `course-item status-${info.status}` },
                e("div", { className: "course-info" }, e("h3", null, course.name), e("p", null, `${course.lectureHours} ساعات أسبوعيًا, غياب: ${course.absenceHours}`)),
                e("div", { className: "course-actions" }, e("button", { onClick: () => onEdit(course), title: "تعديل" }, e(Icons.Edit)), e("button", { onClick: () => onDelete(course.id, course.name), title: "حذف" }, e(Icons.Trash))),
                e("div", { className: "course-meta" },
                    e("div", { className: `meta-item status-${info.status}` }, e(Icons.List), e("span", null, info.remainingText)),
                    e("div", { className: "meta-item" }, e(Icons.Calendar), e("span", null, info.denialDateText))
                ),
                e("div", { className: "quick-controls" },
                    e("div", { className: "last-updated" }, formatRelativeTime(course.lastUpdated)),
                    e("div", { className: "absence-control", style: { width: '120px' } },
                        e("button", { onClick: () => onQuickAbsence(course.id, 1), title: "زيادة غياب" }, e(Icons.Plus)),
                        e("button", { onClick: () => onQuickAbsence(course.id, -1), title: "إنقاص غياب", disabled: course.absenceHours <= 0 }, e(Icons.Minus))
                    )
                ),
                e("div", { className: "progress-bar" }, e("div", { className: "progress-bar-inner", style: { width: `${info.progress}%` } }))
            );
		});

		function App() {
			const data = useAppData();
			useEffect(() => {
				const themeData = THEMES[data.settings.theme] || THEMES.blue;
				Object.entries(themeData).forEach(([key, value]) => document.documentElement.style.setProperty(key, value));
			}, [data.settings.theme]);
			const handleEdit = useCallback((course) => { data.setSelectedCourse(course); window.scrollTo({ top: 0, behavior: "smooth" }); }, [data.setSelectedCourse]);
			return e("div", { className: "app" },
                e("div", { className: "aurora-bg" }, e("div", { className: "aurora-dot aurora-dot-1" }), e("div", { className: "aurora-dot aurora-dot-2" })),
                e("div", { className: "container" },
                    e("header", { className: "main-header" }, e(motion.h1, { layout: true }, "حاسبة الغياب"), e(motion.p, { layout: true }, "مستشارك الدراسي الذكي")),
                    e(SettingsCard, { settings: data.settings, onUpdate: data.updateSettings, weeks: data.semesterWeeks }),
                    e(CourseForm, { onSave: data.handleSaveCourse, selectedCourse: data.selectedCourse, setSelectedCourse: data.setSelectedCourse, isSettingsValid: data.isSettingsValid }),
                    e(motion.div, { layout: true, className: "card" },
                        e("div", { className: "card-header" }, e("h2", null, e(Icons.List), `المواد المحفوظة (${data.courses.length})`)),
                        e(AnimatePresence, null,
                            data.courses.length === 0
                            ? e(motion.div, { key: "empty", initial: { opacity: 0 }, animate: { opacity: 1 } }, e("div", { className: "empty-list-message" }, e(Icons.List), e("p", null, "لم تقم بإضافة أي مواد بعد.")))
                            : e("div", { className: "course-list" }, data.courses.map(course => e(CourseItem, { key: course.id, course, onEdit: handleEdit, onDelete: data.handleDeleteCourse, onQuickAbsence: data.handleQuickAbsence, settings: { ...data.settings, semesterWeeks: data.semesterWeeks } })))
                        )
                    ),
                    e(motion.footer, { layout: true, className: "footer" },
                        e("span", null, `© ${new Date().getFullYear()} | ظلام`),
                        e("div", { className: "footer-controls" },
                            e("div", { className: "theme-picker" }, Object.keys(THEMES).map(key => e("button", { key, title: THEMES[key].name, className: `theme-dot ${data.settings.theme === key ? 'active' : ''}`, onClick: () => data.updateSettings('theme', key) }, e("div", { className: "theme-dot-inner", style: { backgroundColor: THEMES[key]['--color-primary'] } })))),
                            e("button", { onClick: data.handleResetAll, className: "clear-button", title: "مسح كل البيانات" }, e(Icons.Trash)),
                            e("a", { href: "https://t.me/zalam_0", className: "footer-link", target: "_blank", rel: "noopener noreferrer" }, e(Icons.Telegram))
                        )
                    )
                )
            );
		}
		
		const root = ReactDOM.createRoot(document.getElementById("root"));
		root.render(e(StrictMode, null, e(App)));
	</script>
</body>
</html>